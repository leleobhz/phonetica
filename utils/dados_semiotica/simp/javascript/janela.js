{var janela_ativa=null;var obj_filtro=null;class_seletor.instancias=new Array();class_hierarquia.instancias=new Array();class_calendario.instancias=new Array();class_popup.instancias=new Array();}function foco_janela(j){if(janela_ativa){janela_ativa.style.zIndex=janela_ativa.zIndex_original;}janela_ativa=j;janela_ativa.zIndex_original=janela_ativa.style.zIndex;janela_ativa.style.zIndex=1000;}function class_janela(){var that=this;this.caixa=null;this.pai=null;this.visivel=false;this.abrir=function(pai){if(that.visivel){return;}that.pai=pai;that.pai.appendChild(that.caixa);that.visivel=true;foco_janela(that.caixa);};this.fechar=function(){if(!that.visivel){return;}that.pai.removeChild(that.caixa);that.visivel=false;};this.criar_janela=function(texto_titulo,x,y,w,h){that.caixa=document.createElement("div");definir_classe(that.caixa,"caixa");x=Math.max(0,parseInt(x));y=Math.max(0,parseInt(y));w=Math.abs(parseInt(w));h=Math.abs(parseInt(h));if(x){that.caixa.style.left=x+"px";}if(y){that.caixa.style.top=y+"px";}if(w){that.caixa.style.width=w+"px";}if(h){that.caixa.style.height=h+"px";}{that.titulo=document.createElement("h2");definir_classe(that.titulo,"titulo");{var div_texto=document.createElement("div");definir_classe(div_texto,"texto");var texto=document.createTextNode(texto_titulo);div_texto.appendChild(texto);var div_botoes=document.createElement("div");definir_classe(div_botoes,"botoes");{that.bt_fechar=document.createElement("a");definir_classe(that.bt_fechar,"bt_fechar");var texto_bt_fechar=document.createTextNode("fechar");that.bt_fechar.appendChild(texto_bt_fechar);div_botoes.appendChild(that.bt_fechar);}that.titulo.appendChild(div_texto);that.titulo.appendChild(div_botoes);}}that.caixa.appendChild(that.titulo);that.caixa.onmousedown=function(){foco_janela(that.caixa);};that.bt_fechar.onmousedown=function(){that.bt_fechar.style.borderStyle="inset";};that.bt_fechar.onmouseup=function(){that.bt_fechar.style.borderStyle="outset";};that.bt_fechar.onclick=that.fechar;objeto_movel(that.titulo,that.caixa);return that.caixa;};}function class_seletor(link){var that=this;this.id=class_seletor.instancias.length;class_seletor.instancias[this.id]=this;this.link=link;this.url=link.getAttribute("href");this.input=link.parentNode.getElementsByTagName("input").item(0);;this.seletor=null;this.timer_filtro=null;this.ajax=new class_ajax();this.marcar=function(scroll){var i=that.seletor.selecionado?that.seletor.selecionado:0;var item=that.seletor.itens.getElementsByTagName("p").item(i);adicionar_classe(item,"selecionado");if(scroll){if(item.parentNode.firstChild){var item_topo=item.offsetTop-item.parentNode.firstChild.offsetTop;var item_baixo=item_topo+item.offsetHeight;var scroll_topo=item.parentNode.scrollTop;var scroll_baixo=scroll_topo+item.parentNode.offsetHeight;if(item_baixo>scroll_baixo){item.parentNode.scrollTop=item_baixo-item.parentNode.offsetHeight;}else if(item_topo<scroll_topo){item.parentNode.scrollTop=item_topo;}}}};this.desmarcar=function(){var i=that.seletor.selecionado;var item=that.seletor.itens.getElementsByTagName("p").item(i);remover_classe(item,"selecionado");};this.selecionar_anterior=function(){var vt=that.seletor.itens.getElementsByTagName("p");var i=that.seletor.selecionado;var j=0;that.desmarcar();do{if(j>=vt.length){return;}i--;j++;if(i<0){i=vt.length-1;}}while(possui_classe(vt.item(i),"hide"));that.seletor.selecionado=i;that.marcar(true);};this.selecionar_proximo=function(){var vt=that.seletor.itens.getElementsByTagName("p");var i=that.seletor.selecionado;var j=0;that.desmarcar();do{if(j>=vt.length){return;}i++;j++;if(i>=vt.length){i=0;}}while(possui_classe(vt.item(i),"hide"));that.seletor.selecionado=i;that.marcar(true);};this.mudar_item=function(e){var k=(window.event)?e.keyCode:e.which;switch(k){case 13:var i=that.seletor.selecionado;var item=that.seletor.itens.getElementsByTagName("p").item(i);if(get_classe(item)!="hide"){that.input.value=item.codigo;that.seletor.janela.fechar();that.input.focus();}else{var r=window.confirm("Nenhum item selecionado.\nVocê deseja limpar o campo de busca e procurar algum?");if(r){that.seletor.input_busca.value="";obj_filtro=that;filtrar_seletor();that.marcar(true);}}return false;case 38:that.seletor.flag_mouse=false;that.selecionar_anterior();return false;case 40:that.seletor.flag_mouse=false;that.selecionar_proximo();return false;case 27:that.seletor.janela.fechar();that.input.focus();return false;default:that.ativar_timer_filtro();break;}return true;};this.atualizar_itens=function(){limpar(that.seletor.itens);var xml=that.ajax.get_retorno("xml");var entidades=xml.documentElement.getElementsByTagName("entidade");for(var i=0;i<entidades.length;i++){var entidade=entidades.item(i);var codigo=entidade.getElementsByTagName("codigo").item(0).textContent;var valor=entidade.getElementsByTagName("valor").item(0).textContent;var texto_exibido=codigo+": "+valor;var linha=document.createElement("p");linha.pos=i;linha.codigo=codigo;linha.valor=valor;linha.texto_exibido=texto_exibido.toLowerCase();var texto=document.createTextNode(texto_exibido);linha.appendChild(texto);linha.onmousemove=function(){that.seletor.flag_mouse=true;};linha.onmouseover=function(){if(that.seletor.flag_mouse){that.desmarcar();that.seletor.selecionado=this.pos;that.marcar(false);}};linha.onclick=function(){that.input.value=this.codigo;that.seletor.janela.fechar();that.input.focus();};that.seletor.itens.appendChild(linha);}that.seletor.input_busca.removeAttribute("disabled");that.seletor.input_busca.focus();obj_filtro=that;filtrar_seletor();that.marcar(true);};this.ativar_timer_filtro=function(){if(that.timer_filtro){clearTimeout(that.timer_filtro);}obj_filtro=that;that.timer_filtro=setTimeout("filtrar_seletor()",1000);};this.criar_caixa=function(pos){var janela=new class_janela();var caixa=janela.criar_janela("Selecione um item",pos.x-230,pos.y-150);{var busca=document.createElement("div");definir_classe(busca,"busca");busca.link=link;{var id="busca_seletor_"+that.id;var label_busca=document.createElement("label");label_busca.setAttribute("for",id);var texto_label=document.createTextNode("Busca");label_busca.appendChild(texto_label);var input_busca=document.createElement("input");definir_classe(input_busca,"input_busca");input_busca.id=id;input_busca.setAttribute("type","text");input_busca.setAttribute("maxlength","40");input_busca.setAttribute("disabled","disabled");input_busca.onkeydown=that.mudar_item;var atualizar=document.createElement("img");definir_classe(atualizar,"bt_atualizar");atualizar.setAttribute("alt","Atualizar lista");atualizar.setAttribute("src",wwwroot+"imgs/icones/atualizar.gif");atualizar.pode=3;atualizar.onclick=function(){if(that.seletor.input_busca.getAttribute("disabled")){window.alert("Aguarde o carregamento dos dados.");return false;}this.pode--;if(this.pode>0){that.seletor.input_busca.setAttribute("disabled","disabled");that.carregar_itens();}else{window.alert("Atenção: você clicou em atualizar 3 vezes.\nEsta operação consome recursos e deve ser utilizada com moderação.");this.parentNode.removeChild(this);}return true;}}busca.appendChild(label_busca);busca.appendChild(input_busca);busca.appendChild(atualizar);var itens=document.createElement("div");definir_classe(itens,"itens");}caixa.appendChild(busca);caixa.appendChild(itens);that.seletor={janela:janela,itens:itens,input_busca:input_busca,selecionado:0,flag_mouse:false};};this.carregar_itens=function(){that.ajax.set_funcao(that.atualizar_itens);that.ajax.exibir_carregando(that.seletor.itens);that.ajax.consultar("GET",that.url,true,null);};this.link.onclick=function abrir_seletor(e){e=e?e:window.event;e.returnValue=false;if(!that.ajax.xmlhttp){var l=that.url;l=l+((l.indexOf("?")>0)?"&":"?")+"input="+that.input.id;window.open(l,"Busca","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=yes, width=500, height=400");return false;}if(that.seletor==null){var pos=get_posicao_mouse(e);that.criar_caixa(pos);that.carregar_itens();}that.seletor.janela.abrir(document.getElementsByTagName("body").item(0));that.seletor.input_busca.focus();return false;};}function filtrar_seletor(){var busca=obj_filtro.seletor.input_busca.value.toLowerCase();var itens=obj_filtro.seletor.itens.getElementsByTagName("p");if(busca.length==0){var item=obj_filtro.seletor.itens.firstChild;while(item!=null){var valor=item.textContent;limpar(item);item.appendChild(document.createTextNode(valor));remover_classe(item);item=item.nextSibling;}obj_filtro.marcar();return;}for(var i=itens.length-1;i>=0;i--){var item=itens.item(i);var pos=item.texto_exibido.indexOf(busca);if(pos<0){definir_classe(item,"hide");}else{var valor=item.textContent;remover_classe(item);limpar(item);var inicio=document.createCDATASection(valor.substr(0,pos));var meio=document.createElement("strong");meio.appendChild(document.createCDATASection(valor.substr(pos,busca.length)));var fim=document.createCDATASection(valor.substr(pos+busca.length));item.appendChild(inicio);item.appendChild(meio);item.appendChild(fim);}}if(possui_classe(itens.item(obj_filtro.seletor.selecionado),"hide")){obj_filtro.selecionar_proximo();}else{obj_filtro.marcar();}}function class_hierarquia(link){var that=this;this.id=class_hierarquia.instancias.length;class_hierarquia.instancias[this.id]=this;this.nivel=0;that.ul=null;that.pai=null;this.link=link;this.url=link.getAttribute("href");this.ws=wwwroot+"webservice/hierarquia.xml.php";this.input=link.parentNode.getElementsByTagName("input").item(0);;this.seletor=null;this.ajax=new class_ajax();this.set_status=function(texto){var t=document.createTextNode(texto);limpar(that.seletor.status);that.seletor.status.appendChild(t);};this.set_botao=function(botao,tipo){switch(tipo){case "+":botao.setAttribute("src",wwwroot+"imgs/icones/mais.gif");botao.setAttribute("alt","+");botao.setAttribute("title","Abrir Grupo");break;case "-":botao.setAttribute("src",wwwroot+"imgs/icones/menos.gif");botao.setAttribute("alt","-");botao.setAttribute("title","Fechar Grupo");break;}};this.atualizar_itens=function(){var xml=that.ajax.get_retorno("xml");var itens=xml.documentElement.getElementsByTagName("item");var ul=document.createElement("ul");definir_classe(ul,"hierarquia");for(var i=0;i<itens.length;i++){var item=itens.item(i);var nome=item.getAttribute("nome");var valor=item.getAttribute("valor");var eh_grupo=parseInt(item.getAttribute("eh_grupo"));var linha=document.createElement("li");linha.nome=nome;linha.valor=valor;linha.nivel=that.nivel;linha.posicao=i;var linha_lb=document.createElement("span");definir_classe(linha_lb,"lb");linha_lb.appendChild(document.createTextNode(" "));var linha_l=document.createElement("span");if(i<(itens.length-1)){definir_classe(linha_l,"l");}var linha_valor=document.createElement("span");definir_classe(linha_valor,"valor");linha_l.appendChild(linha_valor);linha.appendChild(linha_lb);linha.appendChild(linha_l);{if(eh_grupo==1){var botao=document.createElement("img");definir_classe(botao,"bt_expandir");botao.linha=linha;botao.linha_valor=linha_valor;that.set_botao(botao,"+");botao.onmouseover=function(){if(this.getAttribute("alt")=="+"){that.set_status("Clique para abrir o Grupo");}else{that.set_status("Clique para fechar o Grupo");}};botao.onmouseout=function(){that.set_status("");};botao.onclick=function(){var ul=this.nextSibling;while(ul&&ul.nodeName.toLowerCase()!="ul"){ul=ul.nextSibling;}if(ul){ul.style.display=(ul.style.display=="none")?"inherit":"none";that.set_botao(this,(ul.style.display=="none")?"+":"-");}else{that.pai=this.linha_valor;that.nivel+=1;var url=that.ws+"?link="+that.url;var l=this.linha;while(l.nivel>=0){url=url+"&a["+l.nivel+"]="+l.posicao;l=l.parentNode.parentNode.parentNode.parentNode;}that.set_status("Carregando...");that.ajax.set_funcao(that.atualizar_itens);that.ajax.consultar("GET",url,true,null);that.set_botao(this,"-");}this.onmouseover();};linha_valor.appendChild(botao);}if(valor){var link=document.createElement("a");link.setAttribute("title","Selecionar");link.linha=linha;var texto=document.createTextNode(valor+": "+nome);link.onmouseover=function(){that.set_status("Clique para selecionar o item");};link.onmouseout=function(){that.set_status("");};link.onclick=function(){that.input.value=this.linha.valor;that.seletor.janela.fechar();that.input.focus();};link.appendChild(texto);linha_valor.appendChild(link);}else{var strong=document.createElement("strong");strong.linha=linha;var texto=document.createTextNode(nome);strong.appendChild(texto);linha_valor.appendChild(strong);}}ul.appendChild(linha);}if(itens.length){that.pai.appendChild(ul);}that.set_status("Itens carregados");};this.carregar_itens=function(){that.pai=that.seletor.itens;that.nivel=0;that.ajax.set_funcao(that.atualizar_itens);that.ajax.exibir_carregando(that.seletor.itens);that.ajax.consultar("GET",that.ws+"?link="+that.url,true,null);};this.criar_caixa=function(pos){var janela=new class_janela();var caixa=janela.criar_janela("Selecione um item",pos.x-200,pos.y-100,400);{var itens=document.createElement("div");definir_classe(itens,"itens");var status=document.createElement("div");definir_classe(status,"status")}caixa.appendChild(itens);caixa.appendChild(status);that.seletor={janela:janela,itens:itens,status:status};};this.link.onclick=function abrir_seletor(e){e=e?e:window.event;e.returnValue=false;if(!that.ajax.xmlhttp){var l=that.ws+"?link="+that.url+"&input="+that.input.id;window.open(l,"Busca","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=yes, width=500, height=400");return false;}if(that.seletor==null){var pos=get_posicao_mouse(e);that.criar_caixa(pos);that.carregar_itens();}that.seletor.janela.abrir(document.getElementsByTagName("body").item(0));return false;};}function class_calendario(div){var that=this;this.id=class_calendario.instancias.length;class_calendario.instancias[this.id]=this;this.div_form=div;this.seletor={janela:null,area_calendario:null};this.link=null;this.mes=0;this.ano=0;this.min_ano=0;this.max_ano=0;this.pode_vazio=false;this.get=function(item){return that.div_form.getElementsByTagName("select").item(item).value;};this.get_min_ano=function(){var options=that.div_form.getElementsByTagName("select").item(2).getElementsByTagName("option");if(that.pode_vazio){return options.item(1).value;}return options.item(0).value;};this.get_max_ano=function(){var options=that.div_form.getElementsByTagName("select").item(2).getElementsByTagName("option");return options.item(options.length-1).value;};this.definir_dia=function(td,dia){td.style.cursor="pointer";td.onmouseover=function(){this.style.outline="1px outset #FFFFFF";this.style.backgroundColor="#FFFFFF";};td.onmouseout=function(){this.style.outline="none";this.style.backgroundColor="transparent";};td.onclick=function(){this.style.outline="none";this.style.backgroundColor="transparent";that.div_form.getElementsByTagName("select").item(0).value=dia;that.div_form.getElementsByTagName("select").item(1).value=that.mes+1;that.div_form.getElementsByTagName("select").item(2).value=that.ano;that.seletor.janela.fechar();that.div_form.getElementsByTagName("select").item(0).focus();};};this.set_mes_ano=function(){var hoje=new Date();var mes=hoje.getMonth();var ano=hoje.getFullYear();if(that.get(1)==0){that.mes=mes;}else{that.mes=that.get(1)-1;}if(that.get(2)==0){that.ano=ano;}else{that.ano=that.get(2);}that.min_ano=that.get_min_ano();that.max_ano=that.get_max_ano();};this.criar_caixa=function(pos){var janela=new class_janela();var caixa=janela.criar_janela("Selecione uma data",pos.x-200,pos.y-100,250,"auto");that.seletor.area_calendario=document.createElement("div");caixa.appendChild(that.seletor.area_calendario);that.atualizar_calendario(that.mes,that.ano);that.seletor.janela=janela;};this.atualizar_calendario=function(){var dias_semana=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];var meses=["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];var primeiro_dia=new Date(that.ano,that.mes,1);var ultimo_dia=new Date(that.ano,that.mes+1,0);var cal=document.createElement("table");definir_classe(cal,"calendario");cal.style.margin="3px auto 5px auto";{var thead=document.createElement("thead");var tbody=document.createElement("tbody");}cal.appendChild(thead);cal.appendChild(tbody);var linha=document.createElement("tr");var th=document.createElement("th");var a=document.createElement("a");definir_classe(a,"seta");var seta=document.createTextNode("←");a.appendChild(seta);th.appendChild(a);linha.appendChild(th);th.onclick=function(){that.mes--;if(that.mes==-1){that.mes=11;if(that.ano>that.min_ano){that.ano--;}else{that.ano=that.max_ano;}}that.atualizar_calendario();};if(msie){var th=document.createElement("<th colspan='5'>");}else{var th=document.createElement("th");th.setAttribute("colspan",5);}definir_classe(th,"titulo_calendario");var texto=document.createTextNode(meses[that.mes]+"/"+that.ano);th.appendChild(texto);linha.appendChild(th);var th=document.createElement("th");var a=document.createElement("a");definir_classe(a,"seta");var seta=document.createTextNode("→");a.appendChild(seta);th.appendChild(a);linha.appendChild(th);th.onclick=function(){that.mes++;if(that.mes==12){that.mes=0;if(that.ano<that.max_ano){that.ano++;}else{that.ano=that.min_ano;}}that.atualizar_calendario();};thead.appendChild(linha);linha=document.createElement("tr");var i=0;for(i=0;i<7;i++){var th=document.createElement("th");th.style.width="2em";var texto=document.createTextNode(dias_semana[i]);th.appendChild(texto);linha.appendChild(th);}thead.appendChild(linha);linha=document.createElement("tr");for(i=1;i<=primeiro_dia.getDay();i++){var td=document.createElement("td");linha.appendChild(td);}for(i=1;i<=7-primeiro_dia.getDay();i++){var td=document.createElement("td");var texto=document.createTextNode(i);td.appendChild(texto);linha.appendChild(td);that.definir_dia(td,i);}tbody.appendChild(linha);while(i<=ultimo_dia.getDate()){var linha=document.createElement("tr");for(var s=0;s<=6;s++){var td=document.createElement("td");if(i<=ultimo_dia.getDate()){var texto=document.createTextNode(i);td.appendChild(texto);that.definir_dia(td,i);}linha.appendChild(td);i++;}tbody.appendChild(linha);}that.seletor.area_calendario.style.textAlign="center";that.seletor.area_calendario.style.border="1px solid #CCCCCC";limpar(that.seletor.area_calendario);that.seletor.area_calendario.appendChild(cal);var div_links=document.createElement("div");div_links.style.fontSize='small';var atalhos=document.createTextNode("Atalhos: ");div_links.appendChild(atalhos);var hoje=document.createElement("a");hoje.appendChild(document.createTextNode("Hoje"));hoje.onclick=function(){var hoje=new Date();that.div_form.getElementsByTagName("select").item(0).value=hoje.getDate();that.div_form.getElementsByTagName("select").item(1).value=hoje.getMonth()+1;that.div_form.getElementsByTagName("select").item(2).value=hoje.getFullYear();that.seletor.janela.fechar();that.div_form.getElementsByTagName("select").item(0).focus();};div_links.appendChild(hoje);if(that.pode_vazio){var nenhum=document.createElement("a");nenhum.appendChild(document.createTextNode("Nenhum"));nenhum.onclick=function(){that.div_form.getElementsByTagName("select").item(0).value=0;that.div_form.getElementsByTagName("select").item(1).value=0;that.div_form.getElementsByTagName("select").item(2).value=0;that.seletor.janela.fechar();that.div_form.getElementsByTagName("select").item(0).focus();};div_links.appendChild(document.createTextNode(" | "));div_links.appendChild(nenhum);}that.seletor.area_calendario.appendChild(div_links);};this.abrir_calendario=function(e){that.set_mes_ano();if(that.seletor.janela==null){var pos=get_posicao_mouse(e);that.criar_caixa(pos);}else{that.atualizar_calendario();}that.seletor.janela.abrir(document.getElementsByTagName("body").item(0));};this.adicionar_link=function(){var s="Selecionar pelo Calendario";that.link=document.createElement("img");that.link.setAttribute("src",wwwroot+"imgs/icones/calendario.gif");that.link.setAttribute("alt",s);that.link.setAttribute("title",s);that.link.style.cursor="pointer";that.link.onclick=that.abrir_calendario;var antigo=that.div_form.getElementsByTagName("img");if(antigo.length>0){that.div_form.removeChild(antigo.item(0));}that.div_form.appendChild(that.link);that.pode_vazio=that.div_form.getElementsByTagName("select").item(2).getElementsByTagName("option").item(0).value==0;if(that.pode_vazio){var anular=document.createElement("img");var s="Nenhuma data";anular.setAttribute("src",wwwroot+"imgs/icones/cancelar.gif");anular.setAttribute("alt",s);anular.setAttribute("title",s);anular.style.cursor="pointer";anular.style.marginLeft="5px";anular.onclick=function(){that.div_form.getElementsByTagName("select").item(0).value=0;that.div_form.getElementsByTagName("select").item(1).value=0;that.div_form.getElementsByTagName("select").item(2).value=0;};that.div_form.appendChild(anular);}};this.adicionar_link();}function class_popup(link){var that=this;this.id=class_popup.instancias.length;class_popup.instancias[this.id]=this;this.link=link;this.url=null;this.janela=null;this.area_conteudo=null;this.ajax=new class_ajax();this.criar_caixa=function(pos){var janela=new class_janela();var titulo=that.link.text.substr(0,40);if(titulo!=that.link.text){titulo=titulo+"...";}var caixa=janela.criar_janela(titulo,pos.x-450,pos.y-300,450,300);{that.area_conteudo=document.createElement("div");definir_classe(that.area_conteudo,"conteudo");}caixa.appendChild(that.area_conteudo);that.janela=janela;};this.atualizar_conteudo=function(){limpar(that.area_conteudo);var xml=that.ajax.get_retorno("xml");var div=xml.getElementById("conteudo_popup");div.style.width="auto";var filhos=div.getElementsByTagName("*");for(j=0;j<filhos.length;j++){filhos.item(j).style.width="auto";filhos.item(j).style.margin="0";}try{document.importNode(div,true);that.area_conteudo.appendChild(div);}catch(e){that.area_conteudo.innerHTML=div.innerHTML;}};this.carregar_conteudo=function(){var url=(that.url.indexOf("?")!=-1)?that.url+"&xml=1":that.url+"?xml=1";that.ajax.set_funcao(that.atualizar_conteudo);that.ajax.exibir_carregando(that.area_conteudo);that.ajax.consultar("GET",url,true,null);};this.abrir_popup=function(e){if(that.janela==null){var pos=get_posicao_mouse(e);that.criar_caixa(pos);that.carregar_conteudo();}that.janela.abrir(document.getElementsByTagName("body").item(0));return false;};this.definir_link=function(){if((!that.ajax.xmlhttp)||(that.url!=null)){return;}that.url=that.link.getAttribute("href");that.link.onclick=that.abrir_popup;};this.definir_link();}
